name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run integration tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  # Force official TeamSpeak image in CI (AMD64 environment)
  TEAMSPEAK_IMAGE: "teamspeak:latest"

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      matrix:
        teamspeak-version: ['latest']  # Can extend to test multiple TS3 versions
        
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create test directories
        run: |
          mkdir -p tests test_results scripts
          chmod +x scripts/run-integration-tests.sh

      - name: Build test images
        run: |
          echo "ğŸ—ï¸ Building Docker images for integration tests..."
          
          echo "ğŸ“¦ Using TeamSpeak image for CI: $TEAMSPEAK_IMAGE"
          
          docker compose -f docker-compose.test.yml build
          
      - name: Start TeamSpeak 3 Server
        run: |
          echo "ğŸš€ Starting TeamSpeak 3 server..."
          docker compose -f docker-compose.test.yml up -d teamspeak3-server
          
          echo "ğŸ“‹ Container status after start:"
          docker compose -f docker-compose.test.yml ps -a
          
          echo "ğŸ“‹ Initial server logs:"
          sleep 10
          docker compose -f docker-compose.test.yml logs --tail=20 teamspeak3-server

      - name: Wait for TeamSpeak server
        run: |
          echo "â³ Waiting for TeamSpeak server to be ready..."
          timeout=180
          counter=0
          
          while [ $counter -lt $timeout ]; do
            if docker compose -f docker-compose.test.yml exec -T teamspeak3-server nc -z localhost 10011 2>/dev/null; then
              echo "âœ… TeamSpeak server is ready after ${counter}s"
              break
            fi
            
            # Log progress every 30 seconds
            if [ $((counter % 30)) -eq 0 ] && [ $counter -gt 0 ]; then
              echo "â³ Still waiting... (${counter}s elapsed)"
              echo "ğŸ“‹ Recent server logs:"
              docker compose -f docker-compose.test.yml logs --tail=10 teamspeak3-server
            fi
            
            if [ $counter -eq $timeout ]; then
              echo "âŒ TeamSpeak server failed to start after ${timeout}s"
              echo "ğŸ“‹ Full server logs:"
              docker compose -f docker-compose.test.yml logs teamspeak3-server
              echo "ğŸ“‹ Container status:"
              docker compose -f docker-compose.test.yml ps -a
              exit 1
            fi
            
            sleep 1
            counter=$((counter + 1))
          done

      - name: Test TeamSpeak connection
        run: |
          echo "ğŸ” Testing direct connection to TeamSpeak server..."
          
          # Test basic connection
          echo "Testing raw socket connection..."
          if timeout 10 bash -c "</dev/tcp/localhost/10011"; then
            echo "âœ… Port 10011 is open"
          else
            echo "âŒ Port 10011 is not accessible"
            echo "ğŸ“‹ Network status:"
            docker network ls
            echo "ğŸ“‹ Container ports:"
            docker compose -f docker-compose.test.yml port teamspeak3-server 10011
          fi
          
          # Test ServerQuery connection
          echo "Testing ServerQuery protocol..."
          response=$(echo -e "version\nquit" | nc -w 5 localhost 10011 || echo "FAILED")
          if echo "$response" | grep -q "version="; then
            echo "âœ… ServerQuery is responding correctly"
            echo "Response: $response"
          else
            echo "âŒ ServerQuery test failed"
            echo "Response: $response"
            echo "ğŸ“‹ Recent logs:"
            docker compose -f docker-compose.test.yml logs --tail=30 teamspeak3-server
          fi

      - name: Extract admin token
        run: |
          echo "ğŸ”‘ Extracting TeamSpeak admin token..."
          docker compose -f docker-compose.test.yml up token-extractor
          
          if [ -f scripts/admin_token.txt ]; then
            echo "âœ… Admin token extracted successfully"
            # Don't echo the token for security
          else
            echo "âš ï¸ No admin token found, tests will run without password"
          fi

      - name: Run integration tests
        env:
          TEAMSPEAK_HOST: teamspeak3-server
          TEAMSPEAK_PORT: 10011
          TEAMSPEAK_USER: serveradmin
          TEAMSPEAK_SERVER_ID: 1
          GITHUB_ACTIONS: true
        run: |
          echo "ğŸ§ª Running comprehensive integration tests..."
          
          # Set password from token if available
          if [ -f scripts/admin_token.txt ]; then
            export TEAMSPEAK_PASSWORD=$(cat scripts/admin_token.txt)
          else
            export TEAMSPEAK_PASSWORD=""
          fi
          
          # Run integration tests
          docker compose -f docker-compose.test.yml run --rm \
            -e TEAMSPEAK_HOST=$TEAMSPEAK_HOST \
            -e TEAMSPEAK_PORT=$TEAMSPEAK_PORT \
            -e TEAMSPEAK_USER=$TEAMSPEAK_USER \
            -e TEAMSPEAK_PASSWORD="$TEAMSPEAK_PASSWORD" \
            -e TEAMSPEAK_SERVER_ID=$TEAMSPEAK_SERVER_ID \
            teamspeak-mcp-test integration-test

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()  # Upload results even if tests fail
        with:
          name: integration-test-results-${{ matrix.teamspeak-version }}
          path: |
            test_results/
            scripts/admin_token.txt
          retention-days: 30

      - name: Display test summary
        if: always()
        run: |
          echo "ğŸ“Š Integration Test Summary"
          echo "=========================="
          
          if [ -f test_results/integration_results.json ]; then
            echo "ğŸ“‹ Test results found:"
            
            # Count successes and failures
            if command -v jq >/dev/null 2>&1; then
              successes=$(jq '[.[] | select(.status == "SUCCESS")] | length' test_results/integration_results.json)
              failures=$(jq '[.[] | select(.status == "FAILURE")] | length' test_results/integration_results.json)
              total=$(jq 'length' test_results/integration_results.json)
              
              echo "âœ… Successes: $successes"
              echo "âŒ Failures: $failures"
              echo "ğŸ“Š Total: $total"
              echo "ğŸ¯ Success rate: $(echo "scale=1; $successes * 100 / $total" | bc)%"
              
              if [ $failures -gt 0 ]; then
                echo ""
                echo "âŒ Failed tests:"
                jq -r '.[] | select(.status == "FAILURE") | "  â€¢ \(.tool): \(.message)"' test_results/integration_results.json
              fi
              
              echo ""
              echo "âœ… Successful tests:"
              jq -r '.[] | select(.status == "SUCCESS") | "  â€¢ \(.tool): \(.message)"' test_results/integration_results.json
            else
              echo "ğŸ“„ Raw results (install jq for better formatting):"
              cat test_results/integration_results.json
            fi
          else
            echo "âŒ No test results file found"
          fi

      - name: Show container logs on failure
        if: failure()
        run: |
          echo "ğŸ” Container logs for debugging:"
          echo "================================"
          echo ""
          echo "ğŸ“‹ TeamSpeak 3 Server logs:"
          docker compose -f docker-compose.test.yml logs --tail=100 teamspeak3-server
          echo ""
          echo "ğŸ“‹ MCP Test container logs:"
          docker compose -f docker-compose.test.yml logs --tail=100 teamspeak-mcp-test
          echo ""
          echo "ğŸ“‹ Token extractor logs:"
          docker compose -f docker-compose.test.yml logs token-extractor

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up test environment..."
          docker compose -f docker-compose.test.yml down --volumes --remove-orphans
          docker system prune -f 